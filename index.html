<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>极简自律</title>
    <style>
        :root { --bg: #ffffff; --main: #000000; --gray: #f2f2f2; }
        body { background: var(--bg); color: var(--main); font-family: sans-serif; margin: 0; padding: 20px; }
        .card { background: var(--gray); border-radius: 24px; padding: 20px; margin-bottom: 25px; letter-spacing: -0.5px; }
        h1 { font-size: 32px; font-weight: 900; margin-bottom: 25px; letter-spacing: -1px; }
        label { display: block; font-size: 12px; margin: 10px 0 5px 10px; font-weight: bold; }
        input { width: 100%; border: none; background: #fff; padding: 15px; border-radius: 15px; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; outline: none; }
        .primary-btn { width: 100%; background: var(--main); color: #fff; border: none; padding: 16px; border-radius: 18px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .goal-item { border: 2px solid var(--main); border-radius: 22px; padding: 18px; margin-bottom: 15px; }
        .goal-header { display: flex; justify-content: space-between; align-items: center; }
        .goal-item.done { background: var(--gray); border-color: var(--gray); opacity: 0.6; }
        .check-box { width: 30px; height: 30px; border: 2px solid var(--main); border-radius: 50%; cursor: pointer; flex-shrink: 0; }
        .done .check-box { background: var(--main); position: relative; }
        .done .check-box::after { content: '✓'; color: #fff; position: absolute; left: 8px; top: 2px; font-size: 18px; }
        .sync-btn { background: #000; color: #fff; font-size: 11px; padding: 6px 12px; border-radius: 12px; border: none; margin-top: 10px; cursor: pointer; }
        .delete-link { font-size: 12px; color: #888; background: none; border: none; text-decoration: underline; margin-top: 15px; cursor: pointer; display: block; }
    </style>
</head>
<body>

    <h1>Focus.</h1>

    <div class="card">
        <label>自律目标</label>
        <input type="text" id="gInput" placeholder="写下你的目标...">
        <label>计划天数</label>
        <input type="number" id="targetDays" placeholder="例如：21">
        <label>提醒时间</label>
        <input type="time" id="tInput" value="08:00">
        <button class="primary-btn" onclick="add()">开启计划</button>
    </div>

    <div id="list"></div>

    <script>
        let goals = JSON.parse(localStorage.getItem('my_discipline_final')) || [];

        function add() {
            const title = document.getElementById('gInput').value;
            const days = document.getElementById('targetDays').value;
            const time = document.getElementById('tInput').value;
            if(!title || !days) return alert("请填写完整");

            goals.push({ id: Date.now(), title, targetDays: days, currentDays: 0, time, doneToday: false });
            save();
            syncToSystem(time, title);
            document.getElementById('gInput').value = '';
            document.getElementById('targetDays').value = '';
        }

        // 针对小米 14T Pro 深度优化的同步函数
        function syncToSystem(time, title) {
            const [h, m] = time.split(':');
            const intent = `intent:#Intent;action=android.intent.action.SET_ALARM;i:android.intent.extra.alarm.HOUR=${parseInt(h)};i:android.intent.extra.alarm.MINUTES=${parseInt(m)};s:android.intent.extra.alarm.MESSAGE=${encodeURIComponent(title)};b:android.intent.extra.alarm.SKIP_UI=false;end`;
            
            // 1. 尝试通过“模拟点击”穿透权限
            const a = document.createElement('a');
            a.href = intent;
            a.rel = 'external nofollow';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // 2. 备用方案：如果模拟点击被静默拦截，500ms 后引导用户确认
            // 手动点击对话框的“确定”在小米系统里权重最高
            setTimeout(() => {
                if (!document.hidden) {
                    if (confirm("正在尝试同步到系统闹钟，若未跳转请点击确定手动授权。")) {
                        window.location.href = intent;
                    }
                }
            }, 500);
        }

        function toggle(id) {
            goals = goals.map(g => {
                if(g.id === id) {
                    g.doneToday = !g.doneToday;
                    g.currentDays += g.doneToday ? 1 : -1;
                }
                return g;
            });
            save();
        }

        function del(id) {
            if(confirm("确定删除这个目标吗？")) {
                goals = goals.filter(g => g.id !== id);
                save();
            }
        }

        function save() {
            localStorage.setItem('my_discipline_final', JSON.stringify(goals));
            render();
        }

        function render() {
            document.getElementById('list').innerHTML = goals.map(g => `
                <div class="goal-item ${g.doneToday ? 'done' : ''}">
                    <div class="goal-header">
                        <div>
                            <div style="font-weight:bold; font-size:18px;">${g.title}</div>
                            <div style="font-size:12px; color:#666;">进度: ${g.currentDays}/${g.targetDays} 天</div>
                        </div>
                        <div class="check-box" onclick="toggle(${g.id})"></div>
                    </div>
                    <button class="sync-btn" onclick="syncToSystem('${g.time}', '${g.title}')">⏰ 同步系统闹钟: ${g.time}</button>
                    <button class="delete-link" onclick="del(${g.id})">删除目标</button>
                </div>
            `).reverse().join('');
        }
        render();
    </script>
</body>
</html>
