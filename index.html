<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Focus Pro 深度保活版</title>
    <style>
        :root { --bg: #ffffff; --main: #000000; --red: #ff3b30; --blue: #007aff; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; padding-top: calc(env(safe-area-inset-top) + 20px); }
        
        /* 启动层 */
        #initLayer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-start { background: var(--blue); color: white; border: none; padding: 20px 50px; border-radius: 50px; font-size: 18px; font-weight: bold; margin-top: 30px; }

        .card { background: #f2f2f2; border-radius: 25px; padding: 20px; margin-bottom: 20px; }
        input { width: 100%; border: none; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .primary-btn { width: 100%; background: #000; color: #fff; border: none; padding: 18px; border-radius: 18px; font-weight: bold; }

        /* 闹钟覆盖 */
        #alarmOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--red); color: white; z-index: 88888; flex-direction: column; align-items: center; justify-content: center; }
        
        .goal-item { border: 2px solid #000; border-radius: 20px; padding: 15px; margin-top: 10px; display: flex; align-items: center; position: relative; }
        .goal-item.done { opacity: 0.3; }
        .check-box { width: 30px; height: 30px; border: 2px solid #000; border-radius: 10px; margin-left: auto; }
        .done .check-box { background: #000; }
    </style>
</head>
<body>

    <div id="initLayer" onclick="activateApp()">
        <h1>初始化 Focus</h1>
        <p>点击开启后台提醒权限</p>
        <button class="btn-start">开始自律</button>
    </div>

    <div id="alarmOverlay">
        <h1 id="alarmTitle" style="font-size: 40px;">时间到！</h1>
        <button onclick="stopAlarm()" style="padding:15px 50px; border-radius:30px; border:none; background:#fff; color:red; font-weight:bold;">停止</button>
    </div>

    <h1>Focus.</h1>
    <div class="card">
        <input type="text" id="gInput" placeholder="目标名称">
        <input type="number" id="dInput" placeholder="计划天数">
        <input type="time" id="tInput" value="08:00">
        <button class="primary-btn" onclick="addGoal()">保存计划</button>
    </div>
    <div id="list"></div>

    <audio id="alarmAudio" loop preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <script>
        const audio = document.getElementById('alarmAudio');
        let goals = JSON.parse(localStorage.getItem('focus_v14')) || [];

        // 1. 激活 App 并请求最高权限
        async function activateApp() {
            // 请求通知权限
            if ("Notification" in window) {
                const permission = await Notification.requestPermission();
                if (permission !== "granted") alert("请务必开启通知权限，否则无法后台提醒！");
            }

            // 注册 Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js');
            }

            // 激活声音通道
            audio.muted = true;
            audio.play().then(() => {
                audio.pause();
                audio.muted = false;
                document.getElementById('initLayer').style.display = 'none';
            });
        }

        // 2. 闹钟逻辑 (即使切到后台，只要进程没死就会跑)
        setInterval(() => {
            const now = new Date();
            const curTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const curDate = now.toDateString();

            if (now.getSeconds() === 0) {
                goals.forEach(g => {
                    const isDoneToday = g.lastCheckDate === curDate;
                    if (g.time === curTime && !isDoneToday) {
                        ring(g.title);
                    }
                });
            }
        }, 1000);

        function ring(title) {
            // 播放声音
            audio.currentTime = 0;
            audio.play().catch(() => {});

            // 弹出系统级通知 (这是退出 App 后唯一的提醒手段)
            if (Notification.permission === "granted") {
                const n = new Notification("Focus 闹钟", {
                    body: "该去完成：" + title,
                    tag: "alarm",
                    requireInteraction: true, // 通知不消失
                    silent: false // 强制发出通知音
                });
                n.onclick = () => { window.focus(); stopAlarm(); };
            }

            document.getElementById('alarmTitle').innerText = title;
            document.getElementById('alarmOverlay').style.display = 'flex';
        }

        function stopAlarm() {
            audio.pause();
            document.getElementById('alarmOverlay').style.display = 'none';
        }

        // 3. 基础功能
        function addGoal() {
            const t = document.getElementById('gInput').value;
            const d = document.getElementById('dInput').value;
            const ti = document.getElementById('tInput').value;
            if(!t || !d) return;
            goals.push({ id: Date.now(), title: t, days: d, time: ti, lastCheckDate: "" });
            save();
        }

        function toggleCheck(id) {
            const d = new Date().toDateString();
            goals = goals.map(g => { if(g.id === id) g.lastCheckDate = (g.lastCheckDate===d?"":d); return g; });
            save();
        }

        function save() { localStorage.setItem('focus_v14', JSON.stringify(goals)); render(); }

        function render() {
            const d = new Date().toDateString();
            document.getElementById('list').innerHTML = goals.map(g => `
                <div class="goal-item ${g.lastCheckDate===d?'done':''}" onclick="toggleCheck(${g.id})">
                    <div>
                        <b>${g.title}</b><br>
                        <small>${g.time} | 计划${g.days}天</small>
                    </div>
                    <div class="check-box"></div>
                </div>
            `).join('');
        }
        render();
    </script>
</body>
</html>
