<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Focus Pro Ultimate</title>
    <style>
        :root { --bg: #ffffff; --main: #000000; --red: #ff3b30; --blue: #007aff; --gray: #f2f2f2; --green: #34c759; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; padding-top: calc(env(safe-area-inset-top) + 20px); -webkit-tap-highlight-color: transparent; }
        
        /* 1. å¯åŠ¨å±‚ï¼šè§£é”æƒé™ */
        #initLayer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-start { background: var(--blue); color: white; border: none; padding: 20px 60px; border-radius: 50px; font-size: 20px; font-weight: bold; margin-top: 30px; box-shadow: 0 10px 20px rgba(0,122,255,0.4); }

        /* 2. é—¹é’Ÿå±‚ï¼šè¦†ç›–å…¨å± */
        #alarmOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--red); color: white; z-index: 88888; flex-direction: column; align-items: center; justify-content: center; }
        .btn-stop { margin-top: 50px; padding: 20px 60px; border-radius: 50px; border: none; background: #fff; color: var(--red); font-weight: 900; font-size: 22px; }

        /* 3. è¾“å…¥åŒºåŸŸ */
        .card { background: var(--gray); border-radius: 25px; padding: 25px; margin-bottom: 25px; }
        input { width: 100%; border: none; padding: 15px; border-radius: 15px; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; outline: none; }
        .primary-btn { width: 100%; background: #000; color: #fff; border: none; padding: 18px; border-radius: 18px; font-weight: bold; font-size: 18px; }

        /* 4. ä»»åŠ¡åˆ—è¡¨ */
        .goal-item { border: 2.5px solid #000; border-radius: 22px; padding: 20px; margin-top: 15px; display: flex; align-items: center; position: relative; background: #fff; transition: 0.3s; }
        .goal-item.done { opacity: 0.4; background: #fafafa; border-color: #ddd; }
        .goal-info { flex: 1; cursor: pointer; }
        .goal-title { font-size: 20px; font-weight: 900; margin: 0; }
        .goal-sub { font-size: 12px; color: #666; margin-top: 5px; }

        /* åˆ é™¤æŒ‰é’® */
        .delete-btn { position: absolute; top: 15px; right: 15px; color: var(--red); font-size: 12px; font-weight: bold; border: 1.5px solid var(--red); padding: 3px 10px; border-radius: 8px; cursor: pointer; background: white; z-index: 10; }

        /* æ‰“å‹¾æ–¹æ¡† */
        .check-box { width: 34px; height: 34px; border: 2.5px solid #000; border-radius: 12px; margin-left: 15px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .done .check-box { background: #000; }
        .done .check-box::after { content: 'âœ“'; color: white; font-weight: bold; font-size: 22px; }
    </style>
</head>
<body>

    <div id="initLayer" onclick="activateApp()">
        <div style="font-size: 60px;">ğŸš€</div>
        <h1 style="letter-spacing:-1px;">Focus Pro</h1>
        <p style="opacity:0.7;">ç‚¹å‡»å±å¹•å¼€å¯åå°é—¹é’Ÿæƒé™</p>
        <button class="btn-start">å¼€å§‹è‡ªå¾‹</button>
    </div>

    <div id="alarmOverlay">
        <div style="font-size: 80px; animation: pulse 1s infinite;">â°</div>
        <h1 id="alarmTitle" style="font-size: 40px; margin-top:20px;">æ—¶é—´åˆ°ï¼</h1>
        <button class="btn-stop" onclick="stopAlarm()">åœæ­¢å“é“ƒ</button>
    </div>

    <h1 style="font-weight:900; letter-spacing:-1.5px; font-size: 32px;">Focus.</h1>

    <div class="card">
        <input type="text" id="gInput" placeholder="è‡ªå¾‹ç›®æ ‡åç§°">
        <input type="number" id="dInput" placeholder="è®¡åˆ’å¤©æ•° (å¦‚ 21)">
        <input type="time" id="tInput" value="08:00">
        <button class="primary-btn" onclick="addGoal()">å¼€å¯è®¡åˆ’</button>
    </div>

    <div id="list"></div>

    <audio id="alarmAudio" loop preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <script>
        const STORE_KEY = 'focus_pro_final_v16';
        let goals = JSON.parse(localStorage.getItem(STORE_KEY)) || [];
        const audio = document.getElementById('alarmAudio');

        // 1. åˆå§‹åŒ–åº”ç”¨
        async function activateApp() {
            // è¯·æ±‚ç³»ç»Ÿé€šçŸ¥æƒé™
            if ("Notification" in window) {
                await Notification.requestPermission();
            }
            
            // å°è¯•æ³¨å†Œ Service Worker (ç”¨äºè¾…åŠ©åå°)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(()=>{});
            }

            // è§£é”å£°éŸ³
            audio.muted = true;
            audio.play().then(() => {
                audio.pause();
                audio.muted = false;
                document.getElementById('initLayer').style.display = 'none';
            });
        }

        // 2. æ·»åŠ è®¡åˆ’
        function addGoal() {
            const t = document.getElementById('gInput').value;
            const d = document.getElementById('dInput').value;
            const ti = document.getElementById('tInput').value;
            if(!t || !d) return alert("è¯·å¡«å…¨ä¿¡æ¯");

            goals.push({
                id: Date.now(),
                title: t,
                days: parseInt(d),
                startTime: new Date().setHours(0,0,0,0),
                time: ti,
                lastCheckDate: ""
            });
            save();
            document.getElementById('gInput').value = '';
            document.getElementById('dInput').value = '';
        }

        // 3. åˆ é™¤è®¡åˆ’
        function deleteGoal(id, e) {
            e.stopPropagation(); // é˜»æ­¢è§¦å‘æ‰“å‹¾
            if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ")) {
                goals = goals.filter(g => g.id !== id);
                save();
            }
        }

        // 4. é—¹é’Ÿæ ¸å¿ƒå¼•æ“ (æ¯ç§’ç›‘æµ‹)
        setInterval(() => {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const dateStr = now.toDateString();

            if (now.getSeconds() === 0) {
                goals.forEach(g => {
                    const pastDays = Math.floor((now.getTime() - g.startTime) / (1000*60*60*24));
                    const isDoneToday = g.lastCheckDate === dateStr;
                    
                    // æ»¡è¶³æ—¶é—´ã€æœªè¿‡æœŸã€ä»Šå¤©æœªæ‰“å¡
                    if (g.time === timeStr && pastDays < g.days && !isDoneToday) {
                        triggerAlarm(g.title);
                    }
                });
            }
        }, 1000);

        function triggerAlarm(title) {
            // æ’­æ”¾å£°éŸ³
            audio.currentTime = 0;
            audio.play().catch(()=>{});
            
            // ç³»ç»Ÿé€šçŸ¥
            if (Notification.permission === "granted") {
                new Notification("Focus æé†’", { 
                    body: "è¯¥å»å®Œæˆ: " + title, 
                    requireInteraction: true 
                });
            }

            // å¼¹å‡ºè¦†ç›–å±‚
            document.getElementById('alarmTitle').innerText = title;
            document.getElementById('alarmOverlay').style.display = 'flex';
        }

        function stopAlarm() {
            audio.pause();
            document.getElementById('alarmOverlay').style.display = 'none';
        }

        // 5. æ‰“å¡é€»è¾‘
        function toggleCheck(id) {
            const dStr = new Date().toDateString();
            goals = goals.map(g => {
                if (g.id === id) g.lastCheckDate = (g.lastCheckDate === dStr ? "" : dStr);
                return g;
            });
            save();
        }

        function save() {
            localStorage.setItem(STORE_KEY, JSON.stringify(goals));
            render();
        }

        function render() {
            const dStr = new Date().toDateString();
            document.getElementById('list').innerHTML = goals.map(g => {
                const pastDays = Math.floor((new Date().getTime() - g.startTime) / (1000*60*60*24));
                const remaining = g.days - pastDays;
                const isDone = g.lastCheckDate === dStr;

                return `
                    <div class="goal-item ${isDone ? 'done' : ''}" onclick="toggleCheck(${g.id})">
                        <div class="delete-btn" onclick="deleteGoal(${g.id}, event)">åˆ é™¤</div>
                        <div class="goal-info">
                            <p class="goal-title">${g.title}</p>
                            <p class="goal-sub">æé†’ï¼š${g.time} | å‰© ${remaining > 0 ? remaining : 0} å¤©</p>
                        </div>
                        <div class="check-box"></div>
                    </div>
                `;
            }).reverse().join('');
        }
        render();
    </script>
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</body>
</html>
