<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Focus æç®€è‡ªå¾‹ App</title>
    <style>
        :root { --bg: #ffffff; --main: #000000; --gray: #f2f2f2; --red: #ff3b30; --blue: #007aff; --green: #34c759; }
        body { background: var(--bg); color: var(--main); font-family: -apple-system, sans-serif; margin: 0; padding: env(safe-area-inset-top) 20px 40px 20px; }
        
        h1 { font-size: 38px; font-weight: 900; margin-bottom: 20px; letter-spacing: -1.5px; }
        .card { background: var(--gray); border-radius: 25px; padding: 20px; margin-bottom: 25px; }
        label { display: block; font-size: 12px; margin: 10px 0 5px 10px; font-weight: bold; opacity: 0.5; }
        input { width: 100%; border: none; background: #fff; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        .primary-btn { width: 100%; background: var(--main); color: #fff; border: none; padding: 18px; border-radius: 18px; font-weight: bold; font-size: 18px; cursor: pointer; }
        
        /* åˆ—è¡¨æ¡ç›®æ ·å¼ */
        .goal-item { border: 2.5px solid var(--main); border-radius: 22px; padding: 20px; margin-top: 15px; position: relative; background: #fff; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .goal-item.done { opacity: 0.5; background: var(--gray); border-color: transparent; }
        .goal-content { flex: 1; }
        .goal-title { font-size: 20px; font-weight: 900; }
        .goal-meta { font-size: 12px; color: #666; margin-top: 4px; }
        
        /* æ‰“å‹¾æ–¹æ¡† */
        .check-box { width: 30px; height: 30px; border: 2.5px solid var(--main); border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 15px; flex-shrink: 0; }
        .done .check-box { background: var(--main); }
        .done .check-box::after { content: 'âœ“'; color: white; font-weight: bold; font-size: 20px; }

        /* åˆ é™¤æŒ‰é’® */
        .delete-btn { position: absolute; top: -10px; right: 10px; background: white; color: var(--red); font-size: 11px; font-weight: bold; border: 1.5px solid var(--red); padding: 2px 8px; border-radius: 8px; cursor: pointer; }

        /* é—¹é’Ÿè¦†ç›–å±‚ */
        #alarmOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: var(--red); color:white; z-index:9999; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
        .stop-btn { margin-top:40px; padding:18px 50px; border-radius:50px; border:none; background:white; color:red; font-weight:bold; font-size:20px; }
        #audioFix { background: var(--blue); color: white; text-align: center; padding: 12px; border-radius: 12px; margin-bottom: 15px; font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="alarmOverlay">
        <h2 id="alarmTitle" style="font-size: 40px;">é—¹é’Ÿå“é“ƒ</h2>
        <button class="stop-btn" onclick="stopAlarm()">åœæ­¢å¹¶å»æ‰“å¡</button>
    </div>

    <h1>Focus.</h1>
    <div id="audioFix" onclick="this.style.display='none'">ç‚¹æˆ‘æ¿€æ´»é—¹é’Ÿå£°éŸ³ ğŸ”Š</div>

    <div class="card">
        <label>è‡ªå¾‹ç›®æ ‡</label>
        <input type="text" id="gInput" placeholder="å†™ä¸‹ç›®æ ‡...">
        <label>è®¡åˆ’å¤©æ•°</label>
        <input type="number" id="dInput" placeholder="21">
        <label>å“é“ƒæ—¶é—´</label>
        <input type="time" id="tInput" value="08:00">
        <button class="primary-btn" onclick="addGoal()">æ·»åŠ æ–°è®¡åˆ’</button>
    </div>

    <div id="list"></div>

    <audio id="alarmAudio" loop preload="auto">
        <source src="https://nx-music.oss-cn-beijing.aliyuncs.com/alarm.mp3" type="audio/mpeg">
    </audio>

    <script>
        const STORE_KEY = 'focus_v9_check';
        let goals = JSON.parse(localStorage.getItem(STORE_KEY)) || [];
        const audio = document.getElementById('alarmAudio');
        
        // è‡ªåŠ¨æ¿€æ´»éŸ³é¢‘
        document.addEventListener('click', () => {
            audio.play().then(() => audio.pause()).catch(()=>{});
            document.getElementById('audioFix').style.display = 'none';
        }, { once: true });

        function addGoal() {
            const title = document.getElementById('gInput').value;
            const days = document.getElementById('dInput').value;
            const time = document.getElementById('tInput').value;
            if(!title || !days) return alert("è¯·å¡«å†™å®Œæ•´");

            goals.push({
                id: Date.now(),
                title: title,
                totalDays: parseInt(days),
                startTime: new Date().setHours(0,0,0,0),
                time: time,
                lastCheckDate: "" // è®°å½•ä¸Šæ¬¡æ‰“å¡æ—¥æœŸ
            });
            save();
            document.getElementById('gInput').value = '';
        }

        // æ ¸å¿ƒç›‘æµ‹ï¼šæ¯ç§’æ£€æŸ¥
        setInterval(() => {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const dateStr = now.toDateString();

            if (now.getSeconds() === 0) {
                goals.forEach(g => {
                    const pastDays = Math.floor((now.getTime() - g.startTime) / (1000*60*60*24));
                    // åªæœ‰æœªè¿‡æœŸä¸”ä»Šå¤©è¿˜æ²¡æ‰“è¿‡å‹¾æ‰å“
                    if (g.time === timeStr && pastDays < g.totalDays && g.lastCheckDate !== dateStr) {
                        document.getElementById('alarmTitle').innerText = g.title;
                        document.getElementById('alarmOverlay').style.display = 'flex';
                        audio.play();
                    }
                });
            }
        }, 1000);

        function toggleCheck(id) {
            const dateStr = new Date().toDateString();
            goals = goals.map(g => {
                if (g.id === id) {
                    // å¦‚æœå·²ç»æ‰“è¿‡å‹¾äº†ï¼Œç‚¹å‡»åˆ™å–æ¶ˆï¼›å¦åˆ™æ‰“å‹¾
                    g.lastCheckDate = (g.lastCheckDate === dateStr) ? "" : dateStr;
                }
                return g;
            });
            save();
        }

        function stopAlarm() {
            audio.pause();
            audio.currentTime = 0;
            document.getElementById('alarmOverlay').style.display = 'none';
        }

        function deleteGoal(id) {
            if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
                goals = goals.filter(g => g.id !== id);
                save();
            }
        }

        function save() {
            localStorage.setItem(STORE_KEY, JSON.stringify(goals));
            render();
        }

        function render() {
            const dateStr = new Date().toDateString();
            document.getElementById('list').innerHTML = goals.map(g => {
                const pastDays = Math.floor((new Date().getTime() - g.startTime) / (1000*60*60*24));
                const remaining = g.totalDays - pastDays;
                const isDoneToday = g.lastCheckDate === dateStr;

                return `
                    <div class="goal-item ${isDoneToday ? 'done' : ''}">
                        <div class="delete-btn" onclick="deleteGoal(${g.id})">åˆ é™¤</div>
                        <div class="goal-content">
                            <div class="goal-title">${g.title}</div>
                            <div class="goal-meta">${g.time} | å‰© ${remaining > 0 ? remaining : 0} å¤©</div>
                            ${isDoneToday ? '<div style="color:var(--green); font-size:11px; font-weight:bold; margin-top:4px;">ä»Šæ—¥å·²å®Œæˆ</div>' : ''}
                        </div>
                        <div class="check-box" onclick="toggleCheck(${g.id})"></div>
                    </div>
                `;
            }).reverse().join('');
        }
        render();
    </script>
</body>
</html>
